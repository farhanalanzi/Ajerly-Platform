@model Ajerly_Platform.Models.HomeIndexViewModel
@{
ViewData["Title"] = "Home Page";
}

<div class="text-center">
    <section class="hero-section">
        <div class="hero-content">
            <h1>أرني منتجاتك</h1>
            <p>منصة أجرلي - أسهل طريقة لتأجير واستئجار المنتجات بين الأفراد</p>

            <input id="homeSearchInput" type="text" class="search-bar" placeholder="ابحث عن منتج...">

            <div class="hero-buttons">
                <button class="btn-request" onclick="location.href='@Url.Action("Create", "Requests")'">طلب عرض</button>
                <button class="btn-add" onclick="location.href='@Url.Action("Create", "Listings")'">إضافة عرض</button>
            </div>
        </div>
    </section>

    <!-- ✅ تصنيفات -->
    <section class="category-filter">
        <button class="category-btn @(Model.Category == "الكل" ? "active" : "")" data-category="الكل">الكل</button>
        <button class="category-btn @(Model.Category == "ألعاب وترفيه" ? "active" : "")" data-category="ألعاب وترفيه">ألعاب وترفيه</button>
        <button class="category-btn @(Model.Category == "مستلزمات المنزل" ? "active" : "")" data-category="مستلزمات المنزل">مستلزمات المنزل</button>
        <button class="category-btn @(Model.Category == "مستلزمات السفر" ? "active" : "")" data-category="مستلزمات السفر">مستلزمات السفر</button>
        <button class="category-btn @(Model.Category == "السيارة" ? "active" : "")" data-category="السيارة">السيارة</button>
        <button class="category-btn @(Model.Category == "الأجهزة" ? "active" : "")" data-category="الأجهزة">الأجهزة</button>
        <button class="category-btn @(Model.Category == "الأثاث" ? "active" : "")" data-category="الأثاث">الأثاث</button>
        <button class="category-btn @(Model.Category == "الملابس والأزياء" ? "active" : "")" data-category="الملابس والأزياء">الملابس والأزياء</button>
    </section>

    <!-- ✅ عرض العروض والطلبات -->
    <section class="listings-grid" id="listingsContainer">
        @foreach (var item in Model.CombinedItems)
        {
            var controller = item.Type == "Listing" ? "Listings" : "Requests";
            var tag = item.Type == "Listing" ? "عرض" : "طلب";
        <a class="listing-link" href="@Url.Action("Details", controller, new { id = item.Id })" style="text-decoration:none; color:inherit;">
            <div class="listing-card" data-category="@item.Category" data-type="@(item.Type.ToLower())" data-id="@item.Id">
                <div class="listing-image">
                    @* Render image only if ImageUrl exists. Otherwise render an empty white area without borders or placeholder text *@
                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                    {
                        <img src="@Url.Content(item.ImageUrl)" alt="" />
                    }
                    else
                    {
                        <div class="empty-image" aria-hidden="true"></div>
                    }
                </div>
                <div class="listing-info">
                    <span class="listing-tag">@tag</span>
                    <h3>@item.Title</h3>
                    <p>@item.Description</p>
                    <p><strong>المدينة:</strong> @item.City</p>
                    <p><strong>السعر:</strong> @((item.Price ?? 0)) ريال/@item.PriceUnit</p>
                    <p><strong>الجوال:</strong> @item.Phone</p>
                </div>
            </div>
        </a>
        }

        <div id="noResults" style="display:none; padding:20px; text-align:center; font-weight:bold;">لا توجد نتائج لهذا التصنيف</div>
    </section>
</div>

<script>
    // Client-side filtering: preserve the original order of the cards by hiding/showing existing anchors
    document.addEventListener('DOMContentLoaded', function () {
        const buttons = document.querySelectorAll('.category-btn');
        const container = document.getElementById('listingsContainer');
        const noResultsEl = document.getElementById('noResults');
        if (!container) return;

        // Capture the original ordered list of anchor elements (preserves exact order rendered on server)
        const originalAnchors = Array.from(container.querySelectorAll('.listing-link'));

        function normalize(s) {
            return (s || '').toLowerCase().trim();
        }

        function applyFilter(category) {
            const q = normalize(category);
            const showAll = q === '' || q === 'الكل';

            let visibleCount = 0;

            // Toggle visibility instead of removing/re-appending nodes to keep the original order
            originalAnchors.forEach(anchor => {
                const card = anchor.querySelector('.listing-card');
                const catRaw = card?.dataset.category || '';
                const cat = normalize(catRaw);
                const matched = showAll || (cat && (cat === q || cat.includes(q)));
                anchor.style.display = matched ? '' : 'none';
                if (matched) visibleCount++;
            });

            if (noResultsEl) {
                noResultsEl.style.display = visibleCount === 0 ? '' : 'none';
            }
        }

        buttons.forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                buttons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const category = btn.dataset.category || '';
                applyFilter(category);
            });
        });

        // If a server-selected category exists in Model, apply it on load
        const serverCategory = '@(Model.Category ?? "")';
        if (serverCategory) {
            const matchBtn = Array.from(buttons).find(b => normalize(b.dataset.category) === normalize(serverCategory));
            if (matchBtn) {
                matchBtn.classList.add('active');
                applyFilter(serverCategory);
            }
        }

        // initial: show all (hide noResults if any)
        applyFilter('الكل');

        // --- New: home search live filter (no redirect) ---
        try {
            const homeInput = document.getElementById('homeSearchInput');
            if (homeInput) {
                let t = null;
                function normalizeStr(s) { return (s || '').toLowerCase().trim(); }

                homeInput.addEventListener('input', function (e) {
                    const q = normalizeStr(e.target.value || '');
                    if (t) clearTimeout(t);
                    t = setTimeout(() => {
                        // if empty, restore category filter state (show currently visible by category)
                        if (!q) {
                            // reapply current category selection
                            const activeBtn = Array.from(buttons).find(b => b.classList.contains('active'));
                            applyFilter(activeBtn ? activeBtn.dataset.category : 'الكل');
                            return;
                        }

                        let visibleCount = 0;
                        // iterate original anchors to preserve order
                        originalAnchors.forEach(anchor => {
                            const card = anchor.querySelector('.listing-card');
                            const title = normalizeStr(anchor.querySelector('h3')?.textContent || '');
                            const desc = normalizeStr(anchor.querySelector('p')?.textContent || '');
                            const tag = normalizeStr(anchor.querySelector('.listing-tag')?.textContent || '');
                            const cat = normalizeStr(card?.dataset.category || '');
                            const type = normalizeStr(card?.dataset.type || '');

                            const matched = title.includes(q) || desc.includes(q) || tag.includes(q) || cat.includes(q) || type.includes(q);

                            anchor.style.display = matched ? '' : 'none';
                            if (matched) visibleCount++;
                        });

                        if (noResultsEl) {
                            noResultsEl.style.display = visibleCount === 0 ? '' : 'none';
                        }
                    }, 250);
                });
            }
        } catch (ex) {
            // ignore non-fatal
        }
    });
</script>

