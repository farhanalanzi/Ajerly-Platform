@model Ajerly_Platform.Models.HomeIndexViewModel
@{
ViewData["Title"] = "Home Page";
}

<div class="text-center">
    <section class="hero-section">
        <div class="hero-content">
            <h1>أرني منتجاتك</h1>
            <p>منصة أجرلي - أسهل طريقة لتأجير واستئجار المنتجات بين الأفراد</p>

            <input id="homeSearchInput" type="text" class="search-bar" placeholder="ابحث عن منتج...">

            <div class="hero-buttons">
                <button class="btn-request" onclick="location.href='@Url.Action("Create", "Requests")'">طلب عرض</button>
                <button class="btn-add" onclick="location.href='@Url.Action("Create", "Listings")'">إضافة عرض</button>
            </div>
        </div>
    </section>

    <!-- ✅ تصنيفات -->
    <section class="category-filter">
        <button class="category-btn @(Model.Category == "الكل" ? "active" : "")" data-category="الكل">الكل</button>
        <button class="category-btn @(Model.Category == "ألعاب وترفيه" ? "active" : "")" data-category="ألعاب وترفيه">ألعاب وترفيه</button>
        <button class="category-btn @(Model.Category == "مستلزمات المنزل" ? "active" : "")" data-category="مستلزمات المنزل">مستلزمات المنزل</button>
        <button class="category-btn @(Model.Category == "مستلزمات السفر" ? "active" : "")" data-category="مستلزمات السفر">مستلزمات السفر</button>
        <button class="category-btn @(Model.Category == "السيارة" ? "active" : "")" data-category="السيارة">السيارة</button>
        <button class="category-btn @(Model.Category == "الأجهزة" ? "active" : "")" data-category="الأجهزة">الأجهزة</button>
        <button class="category-btn @(Model.Category == "الأثاث" ? "active" : "")" data-category="الأثاث">الأثاث</button>
        <button class="category-btn @(Model.Category == "الملابس والأزياء" ? "active" : "")" data-category="الملابس والأزياء">الملابس والأزياء</button>
    </section>

    <!-- ✅ عرض العروض والطلبات -->
    <section class="listings-grid" id="listingsContainer">
        @foreach (var item in Model.CombinedItems)
        {
            var controller = item.Type == "Listing" ? "Listings" : "Requests";
            var tag = item.Type == "Listing" ? "عرض" : "طلب";
            var imageUrl = string.IsNullOrEmpty(item.ImageUrl) ? "/images/default.jpg" : Url.Content(item.ImageUrl);
        <a class="listing-link" href="@Url.Action("Details", controller, new { id = item.Id })" style="text-decoration:none; color:inherit;">
            <div class="listing-card" data-category="@item.Category" data-type="@(item.Type?.ToLower())" data-id="@item.Id"
                 data-info='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(new { title = item.Title, city = item.City, desc = item.Description, image = imageUrl, seller = item.SellerName, phone = item.Phone, createdAt = item.CreatedAt.ToString("yyyy-MM-dd") }))'>
                <div class="listing-image">
                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                    {
                        <img src="@imageUrl" alt="" />
                    }
                    else
                    {
                        <div class="empty-image" aria-hidden="true"></div>
                    }
                </div>
                <div class="listing-info">
                    <span class="listing-tag">@tag</span>
                    <h3>@item.Title</h3>

                    <p>
                        <strong>
                           <!-- location svg -->
                           <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="#6b7280" viewBox="0 0 16 16" style="vertical-align:middle;margin-inline-start:6px;">
                             <path d="M8 0a5 5 0 0 0-5 5c0 3.3 5 11 5 11s5-7.7 5-11a5 5 0 0 0-5-5zm0 7.5A2.5 2.5 0 1 1 8 2.5a2.5 2.5 0 0 1 0 5z"/>
                           </svg>
                           @item.City
                        </strong>
                    </p>

                    <p><strong>بواسطة:</strong> @item.SellerName</p>
                </div>
            </div>
        </a>
        }

        <div id="noResults" style="display:none; padding:20px; text-align:center; font-weight:bold;">لا توجد نتائج لهذا التصنيف</div>
    </section>
</div>

<!-- Modal preview markup (appended to the page) -->
<div id="cardPreviewOverlay" class="card-preview-overlay" style="display:none;">
    <div class="card-preview vertical">
        <button class="preview-close" aria-label="إغلاق">×</button>
        <div class="preview-image">
            <img id="previewImg" src="" alt="" />
        </div>
        <div class="preview-content">
            <h2 id="previewTitle"></h2>
            <div class="preview-city"><span class="icon">📍</span> <span id="previewCity"></span></div>
            <div class="preview-desc" id="previewDesc"></div>

            <div class="preview-seller">
                <div class="seller-box">
                    <div>
                        <div class="seller-label" style="font-size:12px;color:#6b7280">المعلن</div>
                        <div class="seller-name" id="previewSeller"></div>
                    </div>
                    <a id="previewPhone" class="btn-contact large" href="#">اتصل</a>
                </div>
            </div>

            <div class="preview-meta" style="margin-top:12px;padding:10px;background:#f8fafc;border-radius:8px;text-align:right;">
                <small>نُشر في: <span id="previewCreatedAt"></span></small>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function(){
            // Removed preview open handlers so clicking a card navigates to its details page.
            // Previously we intercepted clicks to show a modal; now we want normal navigation.

            // Keep simple helper functions in case we need them later
            function qs(sel, base) { return (base || document).querySelector(sel); }

            document.addEventListener('DOMContentLoaded', function(){
                // No interception: anchors behave normally and navigate to /Listings/Details/{id}
                // We still wire the modal close if modal is ever opened by other means.
                var close = qs('.preview-close');
                if (close) close.addEventListener('click', function(){ document.getElementById('cardPreviewOverlay').style.display = 'none'; document.body.style.overflow = ''; });
            });
        })();
    </script>
}
